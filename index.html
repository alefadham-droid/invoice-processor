<script>
    // آدرس Worker شما
    const WORKER_URL = 'https://invoice-proxy.alef-adham.workers.dev';
    
    let selectedFile = null;

    // تنظیمات آپلود فایل
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const processBtn = document.getElementById('processBtn');
    const fileInfo = document.getElementById('fileInfo');

    uploadArea.addEventListener('click', () => fileInput.click());
    
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        
        const file = e.dataTransfer.files[0];
        if (file && file.type.startsWith('image/')) {
            handleFileSelect(file);
        } else {
            alert('لطفاً فقط فایل تصویری انتخاب کنید');
        }
    });

    fileInput.addEventListener('change', (e) => {
        if (e.target.files[0]) {
            handleFileSelect(e.target.files[0]);
        }
    });

    function handleFileSelect(file) {
        selectedFile = file;
        fileInfo.style.display = 'block';
        fileInfo.innerHTML = `
            <strong>✅ فایل انتخاب شد:</strong><br>
            نام: ${file.name}<br>
            حجم: ${(file.size / 1024).toFixed(2)} KB<br>
            نوع: ${file.type}
        `;
        uploadArea.style.background = '#e8f5e8';
        processBtn.disabled = false;
    }

    async function processInvoice() {
        if (!selectedFile) {
            alert('لطفاً یک عکس انتخاب کنید');
            return;
        }

        document.getElementById('loading').style.display = 'block';
        document.getElementById('result').style.display = 'none';
        processBtn.disabled = true;

        try {
            const base64Image = await toBase64(selectedFile);

            const prompt = `به عنوان یک حسابرس حرفه‌ای، لطفاً اطلاعات این فاکتور را استخراج کن.

موارد مورد نیاز:
1. شماره فاکتور
2. تاریخ
3. نام فروشنده
4. جمع کل
5. مالیات (اگر دارد)
6. آیتم‌ها (لیست)

قالب خروجی JSON:
{
    "invoice_number": "شماره فاکتور",
    "date": "تاریخ به فرمت YYYY-MM-DD",
    "seller": "نام فروشنده",
    "total_amount": 0.00,
    "tax": 0.00,
    "items": [
        {"description": "شرح کالا", "quantity": 1, "price": 0.00}
    ]
}`;

            // **بخش دیباگ - ببینیم چه réponses می‌آید**
            console.log('1. ارسال به Worker...');
            
            const response = await fetch(WORKER_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: 'gpt-4-vision-preview',
                    messages: [
                        {
                            role: 'user',
                            content: [
                                {
                                    type: 'text',
                                    text: prompt
                                },
                                {
                                    type: 'image_url',
                                    image_url: {
                                        url: base64Image
                                    }
                                }
                            ]
                        }
                    ],
                    max_tokens: 1000,
                    temperature: 0.1
                })
            });

            console.log('2. وضعیت پاسخ:', response.status);
            
            if (!response.ok) {
                const errorText = await response.text();
                console.log('3. خطای سرور:', errorText);
                throw new Error(`خطای سرور: ${response.status} - ${errorText}`);
            }

            const data = await response.json();
            console.log('4. پاسخ کامل از Worker:', data);
            
            // چک کردن ساختار پاسخ
            if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                console.log('5. ساختار پاسخ نامعتبر است');
                throw new Error('پاسخ از سرور ساختار درستی ندارد');
            }

            console.log('6. محتوای پیام:', data.choices[0].message.content);
            
            // استخراج و نمایش نتیجه
            let result;
            try {
                // گاهی OpenAI داخل کد JSON یک متن اضافی می‌گذارد
                const content = data.choices[0].message.content;
                // پیدا کردن JSON بین علامت‌ها
                const jsonMatch = content.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    result = JSON.parse(jsonMatch[0]);
                } else {
                    result = JSON.parse(content);
                }
                console.log('7. JSON استخراج شده:', result);
            } catch (e) {
                console.log('8. خطای pars کردن JSON:', e);
                result = { error: 'قالب JSON نامعتبر', raw: data.choices[0].message.content };
            }

            document.getElementById('result').innerHTML = `
                <h3>✅ نتیجه پردازش:</h3>
                <pre>${JSON.stringify(result, null, 2)}</pre>
            `;
            document.getElementById('result').style.display = 'block';

        } catch (error) {
            console.log('9. خطای نهایی:', error);
            document.getElementById('result').innerHTML = `
                <h3 style="color: #f44336;">❌ خطا در پردازش</h3>
                <p style="color: #666;">${error.message}</p>
                <p style="font-size: 12px; margin-top: 10px;">لطفاً کنسول مرورگر را باز کنید (F12) و خطاها را ببینید</p>
            `;
            document.getElementById('result').className = 'error';
            document.getElementById('result').style.display = 'block';
        } finally {
            document.getElementById('loading').style.display = 'none';
            processBtn.disabled = false;
        }
    }

    function toBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });
    }
</script>
